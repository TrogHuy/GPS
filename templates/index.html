<!-- templates/index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>GPS Tracking Dashboard</title>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .dashboard { display: flex; flex-wrap: wrap; }
        .panel { margin: 10px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .log-panel { width: 100%; height: 300px; overflow-y: scroll; }
        .chart-panel { width: calc(50% - 52px); height: 400px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        .controls { margin: 20px 0; }
        #path-chart-container, #speed-chart-container { 
            position: relative; 
            height: 350px;
            width: 100%;
        }
    </style>
</head>
<body>
    <h1>GPS Tracking Simulation Dashboard</h1>
    
    <div class="controls">
        <label>
            <input type="checkbox" id="network-issues"> Simulate Network Issues
        </label>
    </div>
    
    <div class="dashboard">
        <div class="panel">
            <h2>Current Location</h2>
            <div id="current-location">
                Waiting for data...
            </div>
        </div>
        
        <!-- New panel for path visualization -->
        <div class="panel chart-panel">
            <h2>GPS Path Tracking</h2>
            <div id="path-chart-container">
                <canvas id="path-chart"></canvas>
            </div>
        </div>
        
        <!-- New panel for speed tracking -->
        <div class="panel chart-panel">
            <h2>Speed Over Time</h2>
            <div id="speed-chart-container">
                <canvas id="speed-chart"></canvas>
            </div>
        </div>
        
        <div class="panel log-panel">
            <h2>Recent GPS Data Log</h2>
            <table id="log-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Latitude</th>
                        <th>Longitude</th>
                        <th>Speed</th>
                        <th>Device ID</th>
                    </tr>
                </thead>
                <tbody id="log-body">
                    <!-- Log entries will be added here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Connect to Socket.IO server
        const socket = io();
        
        // Handle network issues checkbox
        const networkIssuesCheckbox = document.getElementById('network-issues');
        
        // Initialize data arrays for charts
        const pathData = {
            datasets: [{
                label: 'GPS Path',
                backgroundColor: 'rgba(75, 192, 192, 0.5)',
                borderColor: 'rgba(75, 192, 192, 1)',
                pointRadius: 5,
                pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                data: []
            }]
        };
        
        const speedData = {
            labels: [],
            datasets: [{
                label: 'Speed (km/h)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1,
                data: []
            }]
        };
        
        // Initialize charts
        const pathChartCtx = document.getElementById('path-chart').getContext('2d');
        const pathChart = new Chart(pathChartCtx, {
            type: 'scatter',
            data: pathData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                        title: {
                            display: true,
                            text: 'Longitude'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Latitude'
                        }
                    }
                }
            }
        });
        
        const speedChartCtx = document.getElementById('speed-chart').getContext('2d');
        const speedChart = new Chart(speedChartCtx, {
            type: 'line',
            data: speedData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Speed (km/h)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    }
                }
            }
        });
        
        // Maximum number of data points to show in charts
        const MAX_CHART_POINTS = 50;
        
        // Function to update charts with new data
        function updateCharts(data) {
            // Add data to path chart
            pathData.datasets[0].data.push({
                x: data.longitude,
                y: data.latitude
            });
            
            // Keep only the last MAX_CHART_POINTS points
            if (pathData.datasets[0].data.length > MAX_CHART_POINTS) {
                pathData.datasets[0].data.shift();
            }
            
            // Format timestamp for display
            const timeString = data.timestamp.split(' ')[1]; // Extract only the time part
            
            // Add data to speed chart
            speedData.labels.push(timeString);
            speedData.datasets[0].data.push(data.speed);
            
            // Keep only the last MAX_CHART_POINTS points
            if (speedData.labels.length > MAX_CHART_POINTS) {
                speedData.labels.shift();
                speedData.datasets[0].data.shift();
            }
            
            // Update charts
            pathChart.update();
            speedChart.update();
        }
        
        // Listen for new GPS data
        socket.on('new_gps_data', function(data) {
            // Update current location display
            document.getElementById('current-location').innerHTML = `
                <p>Latitude: ${data.latitude.toFixed(6)}</p>
                <p>Longitude: ${data.longitude.toFixed(6)}</p>
                <p>Speed: ${data.speed.toFixed(1)} km/h</p>
                <p>Last Update: ${data.timestamp}</p>
            `;
            
            // Update charts
            updateCharts(data);
            
            // Add to log table
            const logBody = document.getElementById('log-body');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${data.timestamp}</td>
                <td>${data.latitude.toFixed(6)}</td>
                <td>${data.longitude.toFixed(6)}</td>
                <td>${data.speed.toFixed(1)}</td>
                <td>${data.device_id}</td>
            `;
            logBody.prepend(row);
        });
        
        // Load initial history and populate charts
        fetch('/api/history')
            .then(response => response.json())
            .then(data => {
                const logBody = document.getElementById('log-body');
                logBody.innerHTML = '';
                
                // Process data in chronological order for charts
                data.forEach(entry => {
                    // Update charts with historical data
                    updateCharts(entry);
                    
                    // Add to log table
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${entry.timestamp}</td>
                        <td>${entry.latitude.toFixed(6)}</td>
                        <td>${entry.longitude.toFixed(6)}</td>
                        <td>${entry.speed.toFixed(1)}</td>
                        <td>${entry.device_id}</td>
                    `;
                    logBody.prepend(row);
                });
            });
            
        // Toggle network issues simulation
        networkIssuesCheckbox.addEventListener('change', function() {
            // Add functionality here if needed
            console.log("Network issues simulation: " + networkIssuesCheckbox.checked);
        });
    </script>
</body>
</html>